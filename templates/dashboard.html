<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ImageRelation Dashboard | Shopify AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ BASE_URL }}/dashboard/static/style.css">
    <link rel="icon" href="{{ BASE_URL }}/dashboard/static/favicon.ico">
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>
<body>
    <div class="container">
        <header class="header">
            <a href="{{ BASE_URL }}/dashboard" class="logo">
                <div class="logo-icon">AI</div>
                <div class="logo-text">ImageRelation</div>
            </a>
            
            <div class="status-badge">
                <span class="status-dot"></span>
                <span>System Operational</span>
            </div>

            <!-- Add this button in the card header section -->
<div class="card-header">
    <h2 class="card-title">
        <i class="fas fa-images"></i> Image Approval Dashboard
    </h2>
    <div class="flex gap-3">
        <span class="badge badge-pending">
            {{ pending_items|length }} Pending
        </span>
        <form method="POST" action="{{ BASE_URL }}/dashboard/fetch-all-products">
            <button type="submit" class="btn btn-primary btn-sm pulse">
                <i class="fas fa-sync-alt mr-1"></i>Fetch All Products
            </button>
        </form>
    </div>
</div>
        </header>
        
        <main>
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-images"></i> Image Approval Dashboard
                    </h2>
                    <span class="badge badge-pending">
                        {{ pending_items|length }} Pending
                    </span>
                </div>
                
                <div class="card-content">
                    {% if pending_items %}
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Original Images</th>
                                    <th>Processed Images</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in pending_items %}
                                <tr>
                                    <td>
                                        <div class="flex items-center">
                                            <div class="flex-shrink-0 h-10 w-10 bg-indigo-100 rounded-lg flex items-center justify-center text-indigo-700 font-bold">
                                                #{{ item[0] }}
                                            </div>
                                            <div class="ml-4">
                                                <div class="font-medium text-gray-900">Product ID: {{ item[1] }}</div>
                                                <!-- SAFE CHECK FOR TAGS -->
                                                {% if item[2] and "Supplier:apify" in item[2] %}
                                                <span class="badge badge-apify mt-1 inline-block">
                                                    <i class="fas fa-camera"></i> Apify Multi-Angle
                                                </span>
                                                {% elif item[2] and "apify" in item[2].lower() %}
                                                <span class="badge badge-apify mt-1 inline-block">
                                                    <i class="fas fa-camera"></i> Apify Product
                                                </span>
                                                {% elif item[2] %}
                                                <span class="badge badge-pending mt-1 inline-block">
                                                    <i class="fas fa-tag"></i> {{ item[2] }}
                                                </span>
                                                {% else %}
                                                <span class="badge badge-pending mt-1 inline-block">
                                                    <i class="fas fa-info-circle"></i> Standard Product
                                                </span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="image-grid">
                                            {% for img in item[3].split(',')[:2] %}
                                            <div class="image-container">
                                                <img src="{{ img }}" alt="Original image">
                                            </div>
                                            {% endfor %}
                                            {% if item[3].count(',') > 1 %}
                                            <div class="image-container bg-gray-50 border-2 border-dashed rounded-lg flex items-center justify-center text-gray-500 text-sm">
                                                +{{ item[3].count(',') - 1 }}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="image-grid">
                                            {% for img in item[4].split(',') %}
                                            <div class="image-container">
                                                <img src="{{ img }}" alt="Processed image">
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="flex flex-col sm:flex-row gap-2">
                                            <a href="{{ BASE_URL }}/dashboard/approve/{{ item[0] }}" 
                                               class="btn btn-success btn-sm">
                                                <i class="fas fa-check"></i> Approve
                                            </a>
                                            <button onclick="openRejectModal({{ item[0] }})" 
                                                    class="btn btn-danger btn-sm">
                                                <i class="fas fa-times"></i> Reject
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-6 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">
                        <div class="text-gray-500">
                            <i class="fas fa-info-circle mr-2"></i>
                            Images will update in Shopify within 1 minute of approval
                        </div>
                        <form method="POST" action="{{ BASE_URL }}/dashboard/simulate-webhook">
                            <button type="submit" class="btn btn-outline">
                                <i class="fas fa-bolt"></i> Simulate Webhook
                            </button>
                        </form>
                    </div>
                    
                    {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">üñºÔ∏è</div>
                        <h3 class="empty-title">No Pending Approvals</h3>
                        <p class="empty-text">
                            Trigger image processing by updating products in Shopify. 
                            Products with the tag <span class="badge badge-apify">Supplier:apify</span> will be processed automatically.
                        </p>
                        <form method="POST" action="{{ BASE_URL }}/dashboard/simulate-webhook">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-bolt mr-2"></i>Simulate Webhook Test
                            </button>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="text-center text-gray-500 text-sm mt-8">
                <p>
                    <i class="fas fa-robot"></i> AI-powered image processing ‚Ä¢ 
                    <i class="fas fa-cloud"></i> Hosted on Railway ‚Ä¢ 
                    <i class="fas fa-lock"></i> All approvals are manual
                </p>
                <p class="mt-1">
                    System Status: <span class="text-green-600 font-medium">Optimal</span> ‚Ä¢ 
                    Shopify Connection: <span class="text-green-600 font-medium">Active</span>
                </p>
            </div>
        </main>
    </div>
    
    <!-- Reject Modal Template -->
    <div id="rejectModalTemplate" style="display:none;">
        <div class="modal-backdrop">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Reject Images for Product #<span id="modal-product-id"></span></h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="reject-form" method="POST">
                        <div class="form-group">
                            <label for="reason" class="form-label">Reason for rejection</label>
                            <select name="reason" id="reason" class="form-control">
                                <option value="Poor quality">Poor image quality</option>
                                <option value="Wrong colors">Incorrect color representation</option>
                                <option value="Missing lifestyle">Missing lifestyle shot</option>
                                <option value="Composition issues">Bad composition/layout</option>
                                <option value="Other">Other reason</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Add comment (optional)</label>
                            <textarea name="comment" class="form-control" rows="3" placeholder="Additional details..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-actions">
                    <button onclick="closeModal()" class="btn btn-outline">
                        <i class="fas fa-times mr-1"></i>Cancel
                    </button>
                    <button onclick="submitRejection()" class="btn btn-danger">
                        <i class="fas fa-ban mr-1"></i>Confirm Rejection
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let activeModal = null;
        let currentApprovalId = null;
        
        function openRejectModal(approvalId) {
            currentApprovalId = approvalId;
            document.getElementById('modal-product-id').textContent = approvalId;
            
            const modal = document.querySelector('.modal-backdrop');
            modal.style.display = 'block';
            setTimeout(() => {
                modal.style.opacity = '1';
                modal.style.pointerEvents = 'auto';
            }, 10);
            
            document.body.style.overflow = 'hidden';
        }
        
        function closeModal() {
            const modal = document.querySelector('.modal-backdrop');
            modal.style.opacity = '0';
            modal.style.pointerEvents = 'none';
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
            
            document.body.style.overflow = 'auto';
            currentApprovalId = null;
        }
        
        function submitRejection() {
            if (!currentApprovalId) return;
            
            const reason = document.getElementById('reason').value;
            const form = document.getElementById('reject-form');
            form.action = `{{ BASE_URL }}/dashboard/reject/${currentApprovalId}`;
            form.submit();
        }
        
        // Close modal when clicking backdrop
        document.querySelector('.modal-backdrop').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
        
        // Close modal with escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>
</html>
