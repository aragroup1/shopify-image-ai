<!DOCTYPE html>
<html>
<head>
    <title>Image Approval Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="icon" href="/dashboard/static/favicon.ico">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .image-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 1rem;
            max-width: 100%;
        }
        .image-container { 
            border: 1px solid #e2e8f0; 
            border-radius: 0.5rem; 
            overflow: hidden;
            height: 80px;
        }
        .badge-apify { 
            background-color: #ef4444; 
            color: white; 
            padding: 0.25rem 0.5rem; 
            border-radius: 9999px; 
            font-size: 0.75rem; 
        }
        .approve-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .reject-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        .dialog-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .dialog-content {
            background: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            max-width: 500px;
            width: 90%;
        }
    </style>
</head>
<body class="bg-gray-50 py-8">
    <div class="container mx-auto px-4">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">ImageRelation Dashboard</h1>
                <p class="text-gray-500 mt-1">Review and approve AI-processed product images</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow text-right w-full md:w-auto">
                <div class="font-medium mb-1">System Status</div>
                <div class="flex items-center justify-end">
                    <span class="h-3 w-3 bg-green-500 rounded-full mr-2"></span>
                    <span class="text-green-600 font-bold">Operational</span>
                </div>
                <div class="text-xs text-gray-500 mt-1">
                    {% if warnings %}
                        {% for warning in warnings %}
                        <div class="text-yellow-600">{{ warning }}</div>
                        {% endfor %}
                    {% else %}
                        All systems fully operational
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Original Images</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Processed Images</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for item in pending_items %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 h-10 w-10 bg-gray-200 rounded flex items-center justify-center">
                                        <span class="text-gray-500 font-bold">#{{ item[0] }}</span>
                                    </div>
                                    <div class="ml-4">
                                        <div class="text-sm font-medium text-gray-900">Product ID: {{ item[1] }}</div>
                                        {% if "Supplier:apify" in item[2] %}
                                        <span class="badge-apify mt-1 inline-block">Apify Multi-Angle</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="image-grid">
                                    {% for img in item[3].split(',')[:2] %}
                                    <div class="image-container">
                                        <img src="{{ img }}" class="w-full h-full object-contain p-1">
                                    </div>
                                    {% endfor %}
                                    {% if item[3].count(',') > 1 %}
                                    <div class="flex items-center justify-center bg-gray-50 border border-dashed rounded">
                                        <span class="text-gray-500 text-sm">+{{ item[3].count(',') - 1 }} more</span>
                                    </div>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="image-grid">
                                    {% for img in item[4].split(',') %}
                                    <div class="image-container">
                                        <img src="{{ img }}" class="w-full h-full object-contain p-1 bg-blue-50">
                                    </div>
                                    {% endfor %}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                                    <a href="/dashboard/approve/{{ item[0] }}" 
                                       class="px-3 py-1.5 approve-btn text-white rounded hover:opacity-90 transition flex items-center justify-center">
                                        <i class="fas fa-check mr-1"></i> Approve
                                    </a>
                                    <button onclick="document.getElementById('reject-{{ item[0] }}').showModal()" 
                                            class="px-3 py-1.5 reject-btn text-white rounded hover:opacity-90 transition flex items-center justify-center">
                                        <i class="fas fa-times mr-1"></i> Reject
                                    </button>
                                </div>
                            </td>
                        </tr>
                        
                        <!-- Reject modal -->
                        <dialog id="reject-{{ item[0] }}" class="dialog-backdrop">
                            <div class="dialog-content">
                                <h3 class="text-xl font-bold text-gray-800 mb-4">Reject Images for Product #{{ item[1] }}</h3>
                                <form method="POST" action="/dashboard/reject/{{ item[0] }}" class="space-y-4">
                                    <div>
                                        <label class="block text-gray-700 text-sm font-bold mb-2" for="reason">
                                            Reason for rejection
                                        </label>
                                        <select name="reason" id="reason" class="w-full px-4 py-2 border rounded focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                            <option value="Poor quality">Poor image quality</option>
                                            <option value="Wrong colors">Incorrect color representation</option>
                                            <option value="Missing lifestyle shot">Missing lifestyle shot</option>
                                            <option value="Composition issues">Bad composition/layout</option>
                                            <option value="Other">Other reason</option>
                                        </select>
                                    </div>
                                    <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                                        <button type="button" onclick="this.closest('dialog').close()" 
                                                class="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50">
                                            Cancel
                                        </button>
                                        <button type="submit" 
                                                class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition">
                                            Confirm Rejection
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </dialog>
                        {% endfor %}
                        
                        {% if not pending_items %}
                        <tr>
                            <td colspan="4" class="px-6 py-12 text-center text-gray-500">
                                <div class="flex flex-col items-center justify-center">
                                    <div class="text-4xl mb-4">ðŸ“­</div>
                                    <h3 class="text-lg font-medium text-gray-900 mb-1">No pending approvals</h3>
                                    <p class="text-gray-500">Trigger image processing by updating products in Shopify</p>
                                   form method="POST" action="/dashboard/simulate-webhook" style="display:inline;">
    <button type="submit" class="mt-4 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded transition flex items-center">
        <i class="fas fa-bolt mr-2"></i>Simulate Webhook
    </button>
</form>
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="mt-6 text-center text-gray-500 text-sm">
            <p>ImageSharp â€¢ Railway Hosted â€¢ {{ pending_items|length }} pending approvals</p>
        </div>
    </div>
    
    <script>
        // Close modals when clicking backdrop
        document.querySelectorAll('.dialog-backdrop').forEach(backdrop => {
            backdrop.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.close();
                }
            });
        });
        
        // Auto-focus first input in modals
        document.querySelectorAll('dialog').forEach(dialog => {
            dialog.addEventListener('click', function() {
                const input = this.querySelector('input, select, textarea');
                if (input) input.focus();
            });
        });
    </script>
</body>
</html>
